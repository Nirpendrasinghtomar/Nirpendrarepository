USE DBO.NirpendraDB
GO
CREATE PROCEDURE AS CLEAN_DB_FOR_ARCHIVED
 BEGIN
      DECLARE @MYTASK VARCHAR(100)
      DECLARE @MYRECORD_TO_BE_DELETED BIGINT
      DECLARE @MYRECORD_DELETED BIGINT
      DECLARE @EXECUTION_TIME BIGINT
      DECLARE @ERROR VARCHAR(500)
      DECLARE @STARTTIME DATETIME
      DECLARE @ENDTIME DATETIME
 BEGIN TRY
	SET @STARTTIME=GETDATE()
	CREATE TABLE #MYTEMPORARY
		(ID INT)

	INSERT INTO #MYTEMPORARY
	
	SELECT ID FROM NST_TBL_EMPLOYEE EMP
	INNER JOIN NST_TBL_EMPLOYEE_ADDR ADR ON ADR.EMP_ADR_REF_EMP=EMP.ID
	INNER JOIN NST_TBL_DEPARTMENT DEP ON DEP.EMP_DEP_REF_EMP=EMP.ID
	WHERE EMP_ACTIVE='0' AND (DEP.NAME NOT IN('MANAGER','ACCOUNTANT') AND DEP.ROLE<>'CHIEF') 

	SELECT @MYRECORD_TO_BE_DELETED=COUNT(1) FROM #MYTEMPORARY
	
	DELETE * FROM NST_TBL_EMPLOYEE WHERE ID IN (SELECT ID FROM #MYTEMPORARY)
	
	SELECT @MYRECORD_DELETED =@@ROWCOUNT
	DROP TABLE #MYTEMPORARY
	
	SET @ENDTIME=GETDATE()
	SET @EXECUTION_TIME =DATEDIFF(SECOND,@STARTTIME,@ENDTIME)
 END TRY
 BEGIN CATCH
      SELECT @ERROR=SUBSTRING(ERROR_MESSAGE(),0,499)
 END CATCH

      PRINT 'TASK COMPLETE WITH' + @ERROR
      PRINT 'RECORD DELETED ' + @MYRECORD_DELETED  + 'OUT OF ' + @MYRECORD_TO_BE_DELETED 

 END
